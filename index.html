<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexFlow | Pro Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3b82f6; --bg: #0f172a; --card: #1e293b;
            --text: #f8fafc; --text-dim: #94a3b8; --accent: #10b981;
        }
        body {
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; padding-bottom: 80px;
        }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .screen { display: none; }
        .screen.active { display: block; }

        /* Navigation */
        .nav {
            position: fixed; bottom: 0; width: 100%; background: var(--card);
            display: flex; justify-content: space-around; padding: 15px 0;
            border-top: 1px solid #334155; z-index: 100;
        }
        .nav-item { color: var(--text-dim); text-decoration: none; font-size: 0.8rem; cursor: pointer; text-align: center; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        /* Components */
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;
        }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: #ef4444; }
        
        input, select {
            background: #334155; border: 1px solid #475569; color: white;
            padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; margin: 5px 0;
        }

        .exercise-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #334155; }
        .set-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 5px; }
        
        /* Timer Overlay */
        #timer-overlay {
            position: fixed; top: 20px; right: 20px; background: var(--accent);
            padding: 10px 20px; border-radius: 50px; font-weight: bold; display: none;
        }
    </style>
</head>
<body>

<div id="timer-overlay">Rest: <span id="timer-val">60</span>s</div>

<div class="container">
    <div id="screen-home" class="screen active">
        <h1>Welcome Back</h1>
        <div class="card">
            <h3>üèÜ Personal Bests</h3>
            <div id="pb-list"></div>
        </div>
        <h3>Select Workout</h3>
        <div id="home-workout-list"></div>
    </div>

    <div id="screen-workouts" class="screen">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <h1>My Workouts</h1>
            <button class="btn" style="width: auto;" onclick="showEditor()">+ New</button>
        </div>
        <div id="workout-list"></div>
    </div>

    <div id="screen-editor" class="screen">
        <h1 id="editor-title">Create Workout</h1>
        <input type="text" id="edit-workout-name" placeholder="Workout Name (e.g. Leg Day)">
        <div id="editor-exercises"></div>
        <button class="btn btn-outline" onclick="addExerciseToEditor()">+ Add Exercise</button>
        <button class="btn" style="margin-top: 20px;" onclick="saveWorkout()">Save Workout</button>
        <button class="btn btn-danger" style="margin-top: 10px;" onclick="changeScreen('workouts')">Cancel</button>
    </div>

    <div id="screen-session" class="screen">
        <h1 id="session-name">Workout</h1>
        <div id="session-content"></div>
        <button class="btn" style="background: var(--accent);" onclick="finishWorkout()">Finish Workout</button>
    </div>

    <div id="screen-stats" class="screen">
        <h1>Analytics</h1>
        <div class="card">
            <canvas id="statsChart"></canvas>
        </div>
        <div id="history-logs"></div>
    </div>
</div>

<nav class="nav">
    <div class="nav-item active" onclick="changeScreen('home')">üè†<br>Home</div>
    <div class="nav-item" onclick="changeScreen('workouts')">üèãÔ∏è<br>Workouts</div>
    <div class="nav-item" onclick="changeScreen('stats')">üìä<br>Stats</div>
</nav>

<script>
    // --- DATA STATE ---
    let workouts = JSON.parse(localStorage.getItem('fx_workouts')) || [];
    let logs = JSON.parse(localStorage.getItem('fx_logs')) || [];
    let pbs = JSON.parse(localStorage.getItem('fx_pbs')) || {};
    let currentEditingId = null;

    const muscleGroups = ["Chest", "Back", "Legs", "Shoulders", "Arms", "Core"];

    // --- NAVIGATION ---
    function changeScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`screen-${screenId}`).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        if(screenId === 'home') { renderHome(); }
        if(screenId === 'workouts') { renderWorkouts(); }
        if(screenId === 'stats') { renderStats(); }
    }

    // --- HOME LOGIC ---
    function renderHome() {
        const pbDiv = document.getElementById('pb-list');
        pbDiv.innerHTML = Object.entries(pbs).length ? '' : 'No PBs yet.';
        for (const [ex, val] of Object.entries(pbs)) {
            pbDiv.innerHTML += `<div><strong>${ex}</strong>: ${val}kg</div>`;
        }

        const list = document.getElementById('home-workout-list');
        list.innerHTML = workouts.map(w => `
            <div class="card" onclick="startWorkout(${w.id})">
                <strong>${w.name}</strong><br>
                <small>${w.exercises.length} Exercises</small>
            </div>
        `).join('');
    }

    // --- WORKOUT EDITOR ---
    function showEditor(id = null) {
        currentEditingId = id;
        const w = workouts.find(x => x.id === id) || { name: '', exercises: [] };
        document.getElementById('edit-workout-name').value = w.name;
        document.getElementById('editor-exercises').innerHTML = '';
        w.exercises.forEach(ex => addExerciseToEditor(ex));
        changeScreen('editor');
    }

    function addExerciseToEditor(data = { name: '', group: 'Chest', sets: 3 }) {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <input type="text" placeholder="Exercise Name" value="${data.name}" class="ex-name">
            <select class="ex-group">
                ${muscleGroups.map(g => `<option ${data.group === g ? 'selected' : ''}>${g}</option>`).join('')}
            </select>
            <input type="number" placeholder="Default Sets" value="${data.sets}" class="ex-sets">
            <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer;">Delete Exercise</button>
        `;
        document.getElementById('editor-exercises').appendChild(div);
    }

    function saveWorkout() {
        const name = document.getElementById('edit-workout-name').value;
        const exNodes = document.querySelectorAll('#editor-exercises .card');
        const exercises = Array.from(exNodes).map(node => ({
            name: node.querySelector('.ex-name').value,
            group: node.querySelector('.ex-group').value,
            sets: node.querySelector('.ex-sets').value
        }));

        if(!name) return alert("Workout needs a name");

        if(currentEditingId) {
            workouts = workouts.map(w => w.id === currentEditingId ? { ...w, name, exercises } : w);
        } else {
            workouts.push({ id: Date.now(), name, exercises });
        }

        localStorage.setItem('fx_workouts', JSON.stringify(workouts));
        changeScreen('workouts');
    }

    function renderWorkouts() {
        const div = document.getElementById('workout-list');
        div.innerHTML = workouts.map(w => `
            <div class="card" style="display:flex; justify-content:space-between;">
                <div onclick="showEditor(${w.id})"><strong>${w.name}</strong></div>
                <button onclick="deleteWorkout(${w.id})" style="background:none; border:none; color:red;">‚úï</button>
            </div>
        `).join('');
    }

    function deleteWorkout(id) {
        workouts = workouts.filter(w => w.id !== id);
        localStorage.setItem('fx_workouts', JSON.stringify(workouts));
        renderWorkouts();
    }

    // --- SESSION LOGIC ---
    let activeSession = null;
    function startWorkout(id) {
        const w = workouts.find(x => x.id === id);
        activeSession = JSON.parse(JSON.stringify(w));
        document.getElementById('session-name').innerText = activeSession.name;
        
        const content = document.getElementById('session-content');
        content.innerHTML = activeSession.exercises.map((ex, exIdx) => `
            <div class="card">
                <h3>${ex.name} (${ex.group})</h3>
                <div id="ex-${exIdx}-sets">
                    ${Array.from({length: ex.sets}).map((_, setIdx) => renderSetRow(exIdx, setIdx)).join('')}
                </div>
            </div>
        `).join('');
        changeScreen('session');
    }

    function renderSetRow(exIdx, setIdx) {
        return `
            <div class="set-row">
                <input type="number" placeholder="kg" id="w-${exIdx}-${setIdx}" onchange="checkPB('${exIdx}', this.value)">
                <input type="number" placeholder="reps" id="r-${exIdx}-${setIdx}">
                <button class="btn-outline" onclick="triggerRest(${setIdx})">Done</button>
            </div>
        `;
    }

    function triggerRest(setIdx) {
        if(setIdx === 0) return; // Requirement: no timer after first set
        let count = 60;
        const overlay = document.getElementById('timer-overlay');
        const val = document.getElementById('timer-val');
        overlay.style.display = 'block';
        
        const interval = setInterval(() => {
            count--;
            val.innerText = count;
            if(count <= 0) {
                clearInterval(interval);
                overlay.style.display = 'none';
                alert("Rest finished!");
            }
        }, 1000);
    }

    function checkPB(exIdx, weight) {
        const exName = activeSession.exercises[exIdx].name;
        if(!pbs[exName] || parseFloat(weight) > pbs[exName]) {
            pbs[exName] = parseFloat(weight);
            localStorage.setItem('fx_pbs', JSON.stringify(pbs));
        }
    }

    function finishWorkout() {
        logs.push({ date: new Date().toLocaleDateString(), workout: activeSession.name });
        localStorage.setItem('fx_logs', JSON.stringify(logs));
        alert("Workout Saved!");
        changeScreen('home');
    }

    // --- STATS LOGIC ---
    function renderStats() {
        const ctx = document.getElementById('statsChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: logs.map(l => l.date),
                datasets: [{
                    label: 'Workouts Completed',
                    data: logs.map((_, i) => i + 1),
                    borderColor: '#3b82f6',
                    tension: 0.1
                }]
            }
        });
        
        document.getElementById('history-logs').innerHTML = logs.map(l => `
            <div class="card">${l.date} - ${l.workout}</div>
        `).reverse().join('');
    }

    // Initial Load
    renderHome();
</script>

</body>
</html>

